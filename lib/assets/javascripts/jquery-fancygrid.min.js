(function(d){var j=this.Fancygrid={},i=function(a,b){d(a).each(function(a,c){var h=d(c);h.is("select")||h.is("input")?h.val(b):h.text(b)})},g=function(a){a=d(a).first();return a.is("select")||a.is("input")?a.val():a.text()},f=function(a,b){var e={ajaxUrl:"/",ajaxType:"GET",name:"",searchFadeTime:25,searchFadeOpac:0.5,page:1,perPage:25},b=b||{};d.extend(e,b);this.name=b.name;this.container=a;this.settings=e;this.queries=0;this.query={pagination:{page:e.page,per_page:e.perPage},columns:[],conditions:[],
operator:"all",order:{}};this.components={container:a,search:a.find(".fg-search"),searchTemplate:a.find(".fg-search-template"),sortWindow:a.find(".fg-sort-window"),sortContent:a.find(".fg-sort-content"),controls:a.find(".fg-control-bar"),dataWrapper:a.find(".fg-datawrapper"),dataContainer:a.find(".fg-datacontainer"),currentPage:a.find(".fg-current-page"),totalPages:a.find(".fg-total-pages"),perPage:a.find(".fg-per-page"),buttons:{prevPage:a.find(".fg-button-prev"),nextPage:a.find(".fg-button-next"),
refresh:a.find(".fg-button-refresh"),clearSearch:a.find(".fg-button-clear"),toggleSearch:a.find(".fg-button-search"),toggleSort:a.find(".fg-button-sort"),addCriterion:a.find(".fg-button-add-criterion"),removeCriterion:a.find(".fg-button-remove-criterion")}};this.components.searchTemplate.hide();this.components.sortWindow.hide();this.components.sortContent.hide();e.searchVisible||this.components.search.hide();var c=this;this.components.search.find("input[type='text'], select").bind("change.fancygrid",
function(){c.buildConditions();c.refresh()}).bind("focus.fancygrid",function(){d(this).select()});this.components.currentPage.bind("change.fancygrid",function(){c.setPage(g(d(this)));c.refresh()}).bind("focus.fancygrid",function(){d(this).select()});this.components.buttons.prevPage.bind("click.fancygrid",function(a){a.preventDefault();c.flipPages(-1);c.refresh()});this.components.buttons.nextPage.bind("click.fancygrid",function(a){a.preventDefault();c.flipPages(1);c.refresh()});this.components.buttons.refresh.bind("click.fancygrid",
function(a){a.preventDefault();c.refresh()});this.components.buttons.clearSearch.bind("click.fancygrid",function(a){a.preventDefault();c.clearSearch();c.refresh()});this.components.perPage.bind("change.fancygrid",function(a){a.preventDefault();c.setPerPage(g(d(this)));c.refresh()});this.components.buttons.toggleSearch.bind("click.fancygrid",function(a){a.preventDefault();c.toggleSearch()});this.components.buttons.toggleSort.bind("click.fancygrid",function(a){a.preventDefault();c.toggleSort()});this.components.sortWindow.click(function(){c.toggleSort()});
this.components.buttons.removeCriterion.click(function(a){a.preventDefault();c.buildConditions();d(this).parents(".fg-search-criterion").detach()});this.components.buttons.addCriterion.click(function(a){a.preventDefault();c.addSearchCriterion()});a.find(".fg-orderable").click(function(a){a.preventDefault();c.toggleOrder(d(this))})};f.prototype.flipPages=function(a){return this.setPage(this.query.pagination.page+a)};f.prototype.setPage=function(a){a=Math.max(1,a);this.query.pagination.page=a;i(this.components.currentPage,
a);return a};f.prototype.setPages=function(a){a=Math.max(0,a);i(this.components.totalPages,a);return a};f.prototype.setPerPage=function(a){a=Math.max(1,a);this.query.pagination.per_page=a;i(this.components.perPage,a)};f.prototype.setOrder=function(a,b){this.query.order.identifier=a;this.query.order.direction=b;this.container.find(".fg-orderable").attr("fg-sort-order","");this.container.find(".fg-orderable[fg-identifier='"+a+"']").attr("fg-sort-order",b);return this.query.order};f.prototype.toggleOrder=
function(a){var b=a.attr("fg-identifier"),a=a.attr("fg-sort-order");this.setOrder(b,"asc"==a?"desc":"desc"==a?"":"asc");this.refresh()};f.prototype.toggleSort=function(){this.components.sortWindow.css({position:"absolute",top:0,left:0,width:"100%",height:"100%",opacity:0.5});this.components.sortContent.css({position:"absolute",top:0.25*window.innerHeight/2,left:(window.innerWidth-200)/2,width:200});var a=this;this.components.sortContent.find("input[type=submit]").click(function(){a.submitSort();return!1});
this.components.sortContent.find(".fg-sortable").sortable();this.components.sortContent.find(".fg-sortable").disableSelection();this.components.sortWindow.toggle();this.components.sortContent.toggle()};f.prototype.submitSort=function(){this.buildColumns();this.refresh(function(){window.location.reload()})};f.prototype.clearSearch=function(){this.container.find(".fg-search li.fg-search-criterion").detach();this.container.find(".fg-search-criterion *[name='value']").val("");this.query.conditions=[];
return this.query.conditions};f.prototype.buildColumns=function(){var a=this.components.sortContent.find(".fg-sort-item input"),b=this.query.columns=[];a.each(function(a,c){c=d(c);b.push({identifier:c.attr("name"),visible:c.is(":checked"),position:a})});return this.query.columns};f.prototype.buildConditions=function(){this.query.operator=this.container.find("#fg-search-conditions:checked").val()||"all";var a=this.query.conditions=[];this.components.search.find(".fg-search-criterion").each(function(){a.push({identifier:g(d(this).find("#identifier")),
operator:g(d(this).find("#operator")),value:g(d(this).find("#value"))})});return this.query};f.prototype.toggleSearch=function(){this.components.search.toggle();this.query.search_visible=this.components.search.is(":visible");return this.query.search_visible};f.prototype.addSearchCriterion=function(){if(!this.components.searchTemplate)return!1;var a=this,b=d(this.components.searchTemplate.html());this.components.search.find(".fg-search-criteria").append(b);b.find(".fg-button-remove-criterion").click(function(){b.remove();
a.buildConditions()});b.find("input[type='text']").bind("change.fancygrid",function(){a.buildConditions()}).bind("focus.fancygrid",function(){d(this).select()})};f.prototype.refresh=function(a){var b=this,e={fancygrid:{}};e.fancygrid[b.name]=b.query;b.queries+=1;b.container.fadeTo(b.settings.searchFadeTime,b.settings.searchFadeOpac);d.ajax({type:b.settings.ajaxType,url:b.settings.ajaxUrl,data:e,dataType:"html",success:function(a){b.queries-=1;0===b.queries&&(a=d(a).find("#fancygrid_"+b.settings.name),
b.container.find(".fg-row").detach(),b.container.find(".fg-datacontainer").append(a.find(".fg-row")),b.setPage(g(a.find(".fg-current-page"))),b.setPages(g(a.find(".fg-total-pages"))),b.container.fadeTo(b.settings.searchFadeTime,1),b.container.trigger("ajaxSuccess"))},error:function(){b.queries-=1;0===b.queries&&(b.container.find(".fg-row").detach(),b.container.fadeTo(b.settings.searchFadeTime,1),b.container.trigger("ajaxError"))},complete:a})};f.prototype.download=function(a){var b={fancygrid:{}};
b.fancygrid[this.name]=this.query;var e=this.settings.ajaxUrl;e.match(/\.html$/)&&(e=e.substring(0,e.length-5));e=[e,a].join(".");a=d.param(b);b=this.settings.ajaxType;if(e&&a){var a="string"===typeof a?a:d.param(a),c="";d.each(a.split("&"),function(){var a=this.split("=");c+='<input type="hidden" name="'+decodeURIComponent(a[0])+'" value="'+decodeURIComponent(a[1])+'" />'});d('<form action="'+e+'" method="'+(b||"post")+'">'+c+"</form>").appendTo("body").submit().remove()}};d.fn.fancygrid=function(a){j[a.name]=
new f(d(this),a);d(this).data("fancygrid",j[a.name])}})(jQuery);